<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design Archetype Questionnaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Custom styles for Inter font and general layout */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide scrollbar for aesthetic purposes */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <div id="app-container" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <!-- Landing Page Section -->
        <div id="landing-page" class="text-center">
            <h1 class="text-4xl font-bold mb-6 text-gray-800">Which archetype am I?</h1>
            <p class="text-lg text-gray-700 mb-8">By clarifying their creative identity, individuals can better align with projects, teams, and opportunities, while also defining clear paths for personal and professional development.</p>
            <button id="start-quiz-button" class="px-8 py-4 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                Take the quiz
            </button>
        </div>

        <!-- Questionnaire Section (Initially Hidden) -->
        <div id="questionnaire-section" class="hidden">
            <!-- Header "Design Archetype Questionnaire" removed from here -->
            <div id="question-content" class="mb-6">
                <!-- Question will be rendered here by JavaScript -->
            </div>
            <div class="flex justify-between mt-8">
                <button id="prev-button" class="px-6 py-3 rounded-lg font-semibold transition-all duration-300 bg-gray-300 text-gray-600 cursor-not-allowed">
                    Previous
                </button>
                <button id="next-button" class="px-6 py-3 rounded-lg font-semibold bg-green-500 text-white hover:bg-green-600 shadow-md hover:shadow-lg transition-all duration-300">
                    Next
                </button>
            </div>
        </div>

        <!-- Results Modal (initially hidden) -->
        <div id="results-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-3xl font-bold mb-6 text-gray-900 text-center">Your Design Archetype Results</h2>

                <!-- Best Match Section -->
                <div id="best-match-section" class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200 text-center">
                    <!-- Best match content will be rendered here by JavaScript -->
                </div>

                <!-- Star Diagram (Radar Chart) -->
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Archetype Matching Diagram</h3>
                    <div class="h-80">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <!-- Sorted List of Archetypes and Scores -->
                <div class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">All Archetype Scores</h3>
                    <ul id="archetype-list" class="space-y-3">
                        <!-- Sorted list will be rendered here by JavaScript -->
                    </ul>
                </div>

                <div class="text-center mt-8">
                    <button id="restart-button" class="px-8 py-4 rounded-lg font-semibold bg-purple-600 text-white hover:bg-purple-700 shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                        Restart Questionnaire
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for questionnaire state
        let currentStep = 0;
        let userAnswers = {};
        let archetypeRawScores = {};
        let archetypePercentageScores = {};
        let bestMatchedArchetype = null;
        let radarChartInstance = null; // To store the Chart.js instance

        // Archetype definitions with their descriptions and associated keywords/categories
        const archetypes = {
            'Visual Specialist': {
                description: 'Detail-obsessed, focused on polished, pixel-perfect design.',
                keywords: ['Visual Preferences and Detail Orientation'],
                image: 'https://placehold.co/200x200/FFD700/000000?text=Visual+Specialist' // Placeholder image
            },
            'Strategist': {
                description: 'Fueled by imagination, excels at long-term thinking and innovation.',
                keywords: ['Innovation and Strategic Thinking'],
                image: 'https://placehold.co/200x200/FFA500/000000?text=Strategist' // Placeholder image
            },
            'Technician': {
                description: 'Technical expert, excels at interactive prototypes.',
                keywords: ['Technical Inclinations and Prototyping'],
                image: 'https://placehold.co/200x200/8A2BE2/FFFFFF?text=Technician' // Placeholder image
            },
            'Systems Thinker': {
                description: 'Simplifies complex systems, connects the dots across teams.',
                keywords: ['Systems Thinking and Collaboration'],
                image: 'https://placehold.co/200x200/008080/FFFFFF?text=Systems+Thinker' // Placeholder image
            },
            'Connector': {
                description: 'Stakeholder whisperer, strives for common solutions.',
                keywords: ['Communication and Stakeholder Management'],
                image: 'https://placehold.co/200x200/FF6347/FFFFFF?text=Connector' // Placeholder image
            },
            'Scholar': {
                description: 'Excels at interrogating data, revealing insights.',
                keywords: ['Research and Knowledge Building'],
                image: 'https://placehold.co/200x200/6A5ACD/FFFFFF?text=Scholar' // Placeholder image
            },
        };

        // Maximum possible scores for each archetype category based on the questionnaire structure
        // This is calculated by summing the max points each category can get from all questions.
        // Checkbox options contribute +1, Radio options contribute +2.
        const maxPossibleScores = {
            'Visual Specialist': 19, // (Q1:2, Q2:2, Q3:2, Q4:2, Q5:2, Q6:2, Q7:1, Q8:2, Q9:2, Q10:2)
            'Strategist': 21,       // (Q1:3, Q2:2, Q3:3, Q4:2, Q5:2, Q6:2, Q7:1, Q8:2, Q9:2, Q10:2)
            'Technician': 19,       // (Q1:2, Q2:2, Q3:2, Q4:2, Q5:2, Q6:2, Q7:1, Q8:2, Q9:2, Q10:2)
            'Systems Thinker': 21,  // (Q1:3, Q2:2, Q3:3, Q4:2, Q5:2, Q6:2, Q7:1, Q8:2, Q9:2, Q10:2)
            'Connector': 19,        // (Q1:3, Q2:2, Q3:3, Q4:2, Q5:2, Q6:2, Q7:1, Q8:0, Q9:2, Q10:2) - Q8 has no Connector option
            'Scholar': 17,          // (Q1:2, Q2:2, Q3:2, Q4:2, Q5:2, Q6:2, Q7:1, Q8:0, Q9:2, Q10:2) - Q8 has no Scholar option
        };

        // Define the questionnaire structure
        const questionnaire = [
            {
                id: 'q1',
                question: 'Of the following options, what do you consider most important when it comes to Design? Please choose all that apply.',
                type: 'checkbox',
                options: [
                    { text: 'Analyzing complex systems', category: 'Systems Thinking and Collaboration' },
                    { text: 'Identifying connections between different systems, projects or products', category: 'Systems Thinking and Collaboration' },
                    { text: 'Collaborating with others and finding solutions that work for everyone.', category: 'Systems Thinking and Collaboration' },
                    { text: 'Thinking about the long-term implications of design decisions', category: 'Innovation and Strategic Thinking' },
                    { text: 'Navigating ambiguity', category: 'Innovation and Strategic Thinking' },
                    { text: 'Exploring new ideas?', category: 'Innovation and Strategic Thinking' },
                    { text: 'The technical aspects of design implementation', category: 'Technical Inclinations and Prototyping' },
                    { text: 'Creating interactive prototypes to test and refine designs', category: 'Technical Inclinations and Prototyping' },
                    { text: 'The visual details of a design', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Ensuring consistency in design elements', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Facilitating discussions', category: 'Communication and Stakeholder Management' },
                    { text: 'Resolving conflicting viewpoints', category: 'Communication and Stakeholder Management' },
                    { text: 'Creating a collaborative environment', category: 'Communication and Stakeholder Management' },
                    { text: 'Engaging with research and gathering information to inform my designs', category: 'Research and Knowledge Building' },
                    { text: 'Learning new things and expanding my knowledge', category: 'Research and Knowledge Building' },
                ],
            },
            {
                id: 'q2',
                question: 'Of the following options, what do you consider the MOST important when it comes to Design? Please choose only one.',
                type: 'radio',
                options: [], // Piped in from Q1
            },
            {
                id: 'q3',
                question: 'Of the following options, what do you most enjoy doing? Please choose all that apply.',
                type: 'checkbox',
                options: [
                    { text: 'Analyzing complex systems', category: 'Systems Thinking and Collaboration' },
                    { text: 'Identifying connections between different systems, projects or products', category: 'Systems Thinking and Collaboration' },
                    { text: 'Collaborating with others and finding solutions that work for everyone.', category: 'Systems Thinking and Collaboration' },
                    { text: 'Thinking about the long-term implications of design decisions', category: 'Innovation and Strategic Thinking' },
                    { text: 'Navigating ambiguity', category: 'Innovation and Strategic Thinking' },
                    { text: 'Exploring new ideas?', category: 'Innovation and Strategic Thinking' },
                    { text: 'The technical aspects of design implementation', category: 'Technical Inclinations and Prototyping' },
                    { text: 'Creating interactive prototypes to test and refine designs', category: 'Technical Inclinations and Prototyping' },
                    { text: 'The visual details of a design', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Ensuring consistency in design elements', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Facilitating discussions', category: 'Communication and Stakeholder Management' },
                    { text: 'Resolving conflicting viewpoints', category: 'Communication and Stakeholder Management' },
                    { text: 'Creating a collaborative environment', category: 'Communication and Stakeholder Management' },
                    { text: 'Engaging with research and gathering information to inform my designs', category: 'Research and Knowledge Building' },
                    { text: 'Learning new things and expanding my knowledge', category: 'Research and Knowledge Building' },
                ],
            },
            {
                id: 'q4',
                question: 'Of the following options, what do you enjoy doing the MOST? Please choose only one.',
                type: 'radio',
                options: [], // Piped in from Q3
            },
            {
                id: 'q5',
                question: 'When reviewing a design, what is MOST important to you?',
                type: 'radio',
                hasOtherInput: true, // This question has an "Other" input
                options: [
                    { text: 'The overall strategy and vision.', category: 'Innovation and Strategic Thinking' },
                    { text: 'The visual aesthetics and polish.', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'The interactive functionality and technical feasibility.', category: 'Technical Inclinations and Prototyping' },
                    { text: 'The system\'s logic and connections to other parts.', category: 'Systems Thinking and Collaboration' },
                    { text: 'How well it aligns with stakeholder expectations.', category: 'Communication and Stakeholder Management' },
                    { text: 'The underlying data and user insights.', category: 'Research and Knowledge Building' },
                    { text: 'Other (please specify)', category: null, value: 'other_specify' }, // Added value for "Other"
                ],
            },
            {
                id: 'q6',
                question: 'When starting a new project, what do you MOST prefer to do first?',
                type: 'radio',
                options: [
                    { text: 'Define the visual specifications.', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Brainstorm innovative concepts and strategies.', category: 'Innovation and Strategic Thinking' },
                    { text: 'Investigate the technical constraints and opportunities.', category: 'Technical Inclinations and Prototyping' },
                    { text: 'Analyze how this project fits into the larger ecosystem.', category: 'Systems Thinking and Collaboration' },
                    { text: 'Meet with stakeholders to gather different perspectives.', category: 'Communication and Stakeholder Management' },
                    { text: 'Research user needs and market trends.', category: 'Research and Knowledge Building' },
                ],
            },
            {
                id: 'q7',
                question: 'What are your preferred design tools? Please choose all that apply.',
                type: 'checkbox',
                hasOtherInput: true, // This question has an "Other" input
                options: [
                    { text: 'Primarily visual design software (e.g., Figma for mockups).', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Tools for strategy and presentations (e.g., Figjam, Keynote).', category: 'Innovation and Strategic Thinking' },
                    { text: 'Prototyping and coding tools (e.g., Framer, code editors).', category: 'Technical Inclinations and Prototyping' },
                    { text: 'Tools for system mapping and documentation.', category: 'Systems Thinking and Collaboration' },
                    { text: 'Communication and collaboration platforms.', category: 'Communication and Stakeholder Management' },
                    { text: 'Data analysis and research tools.', category: 'Research and Knowledge Building' },
                    { text: 'Other (please specify)', category: null, value: 'other_specify' }, // Added value for "Other"
                ],
            },
            {
                id: 'q8',
                question: 'Of the below options, which do you enjoy the most?',
                type: 'radio',
                options: [
                    { text: 'Designing detailed visual interfaces.', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Developing a comprehensive design strategy.', category: 'Innovation and Strategic Thinking' },
                    { text: 'Building a complex interactive prototype.', category: 'Technical Inclinations and Prototyping' },
                    { text: 'Optimizing a design system for efficiency.', category: 'Systems Thinking and Collaboration' },
                ],
            },
            {
                id: 'q9',
                question: 'When faced with differing opinions on a design, what action are you most likely to take?',
                type: 'radio',
                options: [
                    { text: 'Defend the visual design rationale.', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Focus on the overall strategic goals.', category: 'Innovation and Strategic Thinking' },
                    { text: 'Explore the technical implications of each option.', category: 'Technical Inclinations and Prototyping' },
                    { text: 'Analyze the impact on the larger system.', category: 'Systems Thinking and Collaboration' },
                    { text: 'Seek common ground and facilitate a compromise.', category: 'Communication and Stakeholder Management' },
                    { text: 'Present data and research to support a decision.', category: 'Research and Knowledge Building' },
                ],
            },
            {
                id: 'q10',
                question: 'Of the below options regarding design tasks, which one do you find the most motivating?',
                type: 'radio',
                options: [
                    { text: 'Refining and polishing visual details.', category: 'Visual Preferences and Detail Orientation' },
                    { text: 'Creating innovative and future-oriented concepts.', category: 'Innovation and Strategic Thinking' },
                    { text: 'Solving technical challenges and building prototypes.', category: 'Technical Inclinations and Prototyping' },
                    { text: 'Improving the efficiency and scalability of a system.', category: 'Systems Thinking and Collaboration' },
                    { text: 'Building consensus and fostering collaboration.', category: 'Communication and Stakeholder Management' },
                    { text: 'Deep research and analysis to generate insights.', category: 'Research and Knowledge Building' },
                ],
            },
        ];

        // --- DOM Elements ---
        const landingPageDiv = document.getElementById('landing-page');
        const startQuizButton = document.getElementById('start-quiz-button');
        const questionContentDiv = document.getElementById('question-content');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const questionnaireSection = document.getElementById('questionnaire-section');
        const resultsModal = document.getElementById('results-modal');
        const bestMatchSection = document.getElementById('best-match-section');
        const archetypeListUl = document.getElementById('archetype-list');
        const restartButton = document.getElementById('restart-button');
        const radarChartCanvas = document.getElementById('radarChart');
        // Removed geminiInsightsSection and insightsContentDiv as they are no longer needed

        // --- Functions ---

        // Renders the current question based on currentStep
        function renderQuestion() {
            const currentQ = questionnaire[currentStep];
            let optionsHtml = '';
            let errorMessage = '';

            // Dynamically populate options for Q2 and Q4
            if (currentQ.id === 'q2') {
                const selectedQ1Options = userAnswers['q1'] || [];
                currentQ.options = questionnaire[0].options.filter(opt => selectedQ1Options.includes(opt.text));
                if (currentQ.options.length === 0) {
                    errorMessage = '<p class="text-red-500 text-sm mt-2">Please go back and select options in the first multi-choice question to see options here.</p>';
                }
            } else if (currentQ.id === 'q4') {
                const selectedQ3Options = userAnswers['q3'] || [];
                currentQ.options = questionnaire[2].options.filter(opt => selectedQ3Options.includes(opt.text));
                if (currentQ.options.length === 0) {
                    errorMessage = '<p class="text-red-500 text-sm mt-2">Please go back and select options in the previous multi-choice question to see options here.</p>';
                }
            }

            if (currentQ.type === 'checkbox') {
                optionsHtml = currentQ.options.map((option, index) => {
                    const isOther = option.value === 'other_specify';
                    const isChecked = (userAnswers[currentQ.id] && userAnswers[currentQ.id].includes(option.text));
                    const otherInputId = `other-input-${currentQ.id}`;
                    const otherTextInputValue = userAnswers[`${currentQ.id}_other_text`] || '';

                    return `
                        <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200">
                            <input
                                type="checkbox"
                                name="${currentQ.id}"
                                value="${option.text}"
                                class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                                ${isChecked ? 'checked' : ''}
                            />
                            <span class="ml-3 text-gray-700">${option.text}</span>
                        </label>
                        ${isOther ? `
                            <div id="${otherInputId}" class="ml-8 mt-2 ${isChecked ? '' : 'hidden'}">
                                <input
                                    type="text"
                                    placeholder="Please specify"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    value="${otherTextInputValue}"
                                    oninput="handleOtherTextInput('${currentQ.id}', this.value)"
                                />
                            </div>
                        ` : ''}
                    `;
                }).join('');
            } else if (currentQ.type === 'radio') {
                optionsHtml = currentQ.options.map((option, index) => {
                    const isOther = option.value === 'other_specify';
                    const isSelected = userAnswers[currentQ.id] === option.text;
                    const otherInputId = `other-input-${currentQ.id}`;
                    const otherTextInputValue = userAnswers[`${currentQ.id}_other_text`] || '';

                    return `
                        <label class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200">
                            <input
                                type="radio"
                                name="${currentQ.id}"
                                value="${option.text}"
                                class="form-radio h-5 w-5 text-blue-600 focus:ring-blue-500"
                                ${isSelected ? 'checked' : ''}
                            />
                            <span class="ml-3 text-gray-700">${option.text}</span>
                        </label>
                        ${isOther ? `
                            <div id="${otherInputId}" class="ml-8 mt-2 ${isSelected ? '' : 'hidden'}">
                                <input
                                    type="text"
                                    placeholder="Please specify"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    value="${otherTextInputValue}"
                                    oninput="handleOtherTextInput('${currentQ.id}', this.value)"
                                />
                            </div>
                        ` : ''}
                    `;
                }).join('');
            }

            questionContentDiv.innerHTML = `
                <p class="text-lg text-gray-700 mb-4">${currentQ.question}</p>
                <div class="space-y-3">
                    ${optionsHtml}
                </div>
                ${errorMessage}
            `;

            // Update button states
            prevButton.disabled = currentStep === 0;
            nextButton.textContent = currentStep === questionnaire.length - 1 ? 'Submit' : 'Next';
            if (currentStep === 0) {
                prevButton.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                prevButton.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-600', 'shadow-md', 'hover:shadow-lg');
            } else {
                prevButton.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                prevButton.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600', 'shadow-md', 'hover:shadow-lg');
            }

            // Add event listeners for the newly rendered inputs
            const inputs = questionContentDiv.querySelectorAll('input[type="checkbox"], input[type="radio"]');
            inputs.forEach(input => {
                input.addEventListener('change', (event) => {
                    handleAnswerChange(currentQ.id, event.target.value, currentQ.type);
                    // Toggle visibility of other input field if applicable
                    if (currentQ.hasOtherInput) {
                        const otherInputDiv = document.getElementById(`other-input-${currentQ.id}`);
                        if (otherInputDiv) {
                            const isOtherSelected = (currentQ.type === 'checkbox' && event.target.checked && event.target.value === 'Other (please specify)') ||
                                                    (currentQ.type === 'radio' && event.target.value === 'Other (please specify)');
                            otherInputDiv.classList.toggle('hidden', !isOtherSelected);
                            if (!isOtherSelected) {
                                // Clear the text input if "Other" is deselected
                                userAnswers[`${currentQ.id}_other_text`] = '';
                                const otherTextInput = otherInputDiv.querySelector('input[type="text"]');
                                if (otherTextInput) otherTextInput.value = '';
                            }
                        }
                    }
                });
            });
        }

        // Handles changes to answers and updates userAnswers object
        function handleAnswerChange(questionId, value, type) {
            if (type === 'checkbox') {
                if (!userAnswers[questionId]) {
                    userAnswers[questionId] = [];
                }
                if (userAnswers[questionId].includes(value)) {
                    userAnswers[questionId] = userAnswers[questionId].filter(item => item !== value);
                } else {
                    userAnswers[questionId].push(value);
                }
            } else { // radio
                userAnswers[questionId] = value;
            }
        }

        // Handles input from the "Other (please specify)" text field
        function handleOtherTextInput(questionId, text) {
            userAnswers[`${questionId}_other_text`] = text;
        }

        // Navigates to the next question or submits the questionnaire
        function nextStep() {
            const currentQ = questionnaire[currentStep];
            // Basic validation: ensure an answer is selected for radio buttons
            if (currentQ.type === 'radio') {
                if (!userAnswers[currentQ.id]) {
                    alert('Please select an option before proceeding.');
                    return;
                }
                if (currentQ.id === 'q5' && userAnswers[currentQ.id] === 'Other (please specify)' && (!userAnswers[`${currentQ.id}_other_text`] || userAnswers[`${currentQ.id}_other_text`].trim() === '')) {
                    alert('Please specify your "Other" option.');
                    return;
                }
            }
            if (currentQ.type === 'checkbox') {
                if (!userAnswers[currentQ.id] || userAnswers[currentQ.id].length === 0) {
                    alert('Please select at least one option before proceeding.');
                    return;
                }
                if (currentQ.id === 'q7' && userAnswers[currentQ.id].includes('Other (please specify)') && (!userAnswers[`${currentQ.id}_other_text`] || userAnswers[`${currentQ.id}_other_text`].trim() === '')) {
                    alert('Please specify your "Other" option.');
                    return;
                }
            }

            if (currentStep < questionnaire.length - 1) {
                currentStep++;
                renderQuestion();
            } else {
                calculateScores();
                showResults();
            }
        }

        // Navigates to the previous question
        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderQuestion();
            }
        }

        // Calculates archetype scores (raw and percentage)
        function calculateScores() {
            // Initialize all archetype raw scores to 0
            Object.keys(archetypes).forEach(archetype => {
                archetypeRawScores[archetype] = 0;
            });

            // Iterate through answers and update raw scores
            Object.entries(userAnswers).forEach(([questionId, answerValue]) => {
                // Skip 'other_text' entries directly
                if (questionId.endsWith('_other_text')) return;

                const questionDef = questionnaire.find(q => q.id === questionId);
                if (!questionDef) return;

                if (Array.isArray(answerValue)) { // Checkbox answers
                    answerValue.forEach(selectedText => {
                        const option = questionDef.options.find(opt => opt.text === selectedText);
                        if (option && option.category) {
                            Object.entries(archetypes).forEach(([archetype, data]) => {
                                if (data.keywords.includes(option.category)) {
                                    archetypeRawScores[archetype] = (archetypeRawScores[archetype] || 0) + 1;
                                }
                            });
                        }
                    });
                } else { // Radio answers
                    let originalOption = null;
                    if (questionId === 'q2' && userAnswers['q1']) {
                        originalOption = questionnaire[0].options.find(opt => opt.text === answerValue);
                    } else if (questionId === 'q4' && userAnswers['q3']) {
                        originalOption = questionnaire[2].options.find(opt => opt.text === answerValue);
                    } else {
                        originalOption = questionDef.options.find(opt => opt.text === answerValue);
                    }

                    if (originalOption && originalOption.category) {
                        Object.entries(archetypes).forEach(([archetype, data]) => {
                            if (data.keywords.includes(originalOption.category)) {
                                archetypeRawScores[archetype] = (archetypeRawScores[archetype] || 0) + 2; // Give more weight to single choice answers
                            }
                        });
                    }
                }
            });

            // Calculate percentage scores
            Object.entries(archetypeRawScores).forEach(([archetype, rawScore]) => {
                const maxScore = maxPossibleScores[archetype];
                if (maxScore > 0) {
                    archetypePercentageScores[archetype] = parseFloat(((rawScore / maxScore) * 100).toFixed(1));
                } else {
                    archetypePercentageScores[archetype] = 0;
                }
            });

            // Determine the best match based on percentage scores
            let maxPercentage = -1;
            let bestArchetype = null;
            Object.entries(archetypePercentageScores).forEach(([archetype, percentage]) => {
                if (percentage > maxPercentage) {
                    maxPercentage = percentage;
                    bestArchetype = archetype;
                }
            });
            bestMatchedArchetype = bestArchetype;
        }

        // Displays the results modal
        function showResults() {
            questionnaireSection.classList.add('hidden');
            resultsModal.classList.remove('hidden');
            // Removed geminiInsightsSection.classList.add('hidden');

            // Display best match
            if (bestMatchedArchetype) {
                bestMatchSection.innerHTML = `
                    <h3 class="text-2xl font-semibold text-blue-700 mb-3">
                        Your Best Match: ${bestMatchedArchetype} (${archetypePercentageScores[bestMatchedArchetype]}%)
                    </h3>
                    <img
                        src="${archetypes[bestMatchedArchetype]?.image}"
                        alt="${bestMatchedArchetype}"
                        class="mx-auto mb-4 rounded-full w-32 h-32 object-cover border-4 border-blue-300"
                        onerror="this.onerror=null;this.src='https://placehold.co/200x200/CCCCCC/000000?text=${bestMatchedArchetype.replace(/\s/g, '+')}';"
                    />
                    <p class="text-lg text-gray-800 mb-4">${archetypes[bestMatchedArchetype]?.description}</p>
                    <!-- Removed Get More Insights button -->
                `;
            }

            // Render Radar Chart
            if (radarChartInstance) {
                radarChartInstance.destroy(); // Destroy previous instance if exists
            }
            const radarCtx = radarChartCanvas.getContext('2d');
            radarChartInstance = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: Object.keys(archetypePercentageScores),
                    datasets: [
                        {
                            label: 'Your Archetype Scores (%)',
                            data: Object.values(archetypePercentageScores),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(75, 192, 192, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: false
                            },
                            suggestedMin: 0,
                            suggestedMax: 100, // Max for percentage
                            ticks: {
                                beginAtZero: true,
                                callback: function(value) {
                                    return value + '%'; // Add percentage sign to ticks
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '%'; // Add percentage sign to tooltip
                                }
                            }
                        }
                    }
                }
            });

            // Display sorted list of archetypes and scores
            const sortedArchetypes = Object.entries(archetypePercentageScores).sort(([, scoreA], [, scoreB]) => scoreB - scoreA);
            archetypeListUl.innerHTML = sortedArchetypes.map(([archetype, score]) => `
                <li class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
                    <span class="text-lg font-medium text-gray-700">${archetype}</span>
                    <span class="text-xl font-bold text-blue-600">${score}%</span>
                </li>
            `).join('');
        }

        // Resets the questionnaire and hides results modal
        function restartQuestionnaire() {
            currentStep = 0;
            userAnswers = {};
            archetypeRawScores = {};
            archetypePercentageScores = {};
            bestMatchedArchetype = null;
            if (radarChartInstance) {
                radarChartInstance.destroy();
                radarChartInstance = null;
            }
            resultsModal.classList.add('hidden');
            landingPageDiv.classList.remove('hidden'); // Go back to landing page
            questionnaireSection.classList.add('hidden'); // Ensure questionnaire is hidden
            // Removed geminiInsightsSection.classList.add('hidden'); // Hide insights section on restart
            // insightsContentDiv.innerHTML = ''; // Clear previous insights
            // No need to call renderQuestion here, as the landing page is shown
        }

        // --- Event Listeners ---
        startQuizButton.addEventListener('click', () => {
            landingPageDiv.classList.add('hidden');
            questionnaireSection.classList.remove('hidden');
            renderQuestion(); // Start the quiz
        });
        nextButton.addEventListener('click', nextStep);
        prevButton.addEventListener('click', prevStep);
        restartButton.addEventListener('click', restartQuestionnaire);

        // Expose handleOtherTextInput to global scope for inline oninput
        window.handleOtherTextInput = handleOtherTextInput;

        // Initial state on page load: show landing page, hide questionnaire
        window.onload = () => {
            landingPageDiv.classList.remove('hidden');
            questionnaireSection.classList.add('hidden');
            resultsModal.classList.add('hidden');
        };
    </script>
</body>
</html>
